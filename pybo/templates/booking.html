<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>전시대신청</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans+KR:400,700&display=swap">
    <link rel="stylesheet" href="/static/style.css">
    <style>
        table, th, td {
            border: 1px solid black;
            border-collapse: collapse;
            table-layout: fixed;
            width: 100px;
        }
        th, td {
            padding: 5px;
            text-align: right;
            table-layout: fixed;
            width: 100px;
        }
    </style>
    <script>
       function apply(cell) {
            var username = "{{ username }}";
            var isApplied = cell.innerText.includes(username);

            // 이미 다른 사용자가 신청한 경우
            if (cell.innerText !== "신청" && !isApplied) {
                return;
            }

            // 자신의 이름일 때 취소

            if (isApplied) {
                cell.innerHTML = '<button onclick="apply(this.parentElement)">신청</button>';
                enableOtherButtons();
                updateTableData(cell.id, "cancel");
                return;
            }

            // 이미 다른 사용자가 해당 셀을 신청한 경우
            var table = cell.parentElement.parentElement.parentElement;
            var rows = table.rows;
            for (var i = 0; i < rows.length; i++) {
                var cells = rows[i].cells;
                for (var j = 0; j < cells.length; j++) {
                    if (cells[j].innerText.includes(username)) {
                        return;
                    }
                }
            }

            cell.innerHTML = username + ' <button onclick="apply(this.parentElement)">취소</button>';
            disableOtherButtons();
            updateTableData(cell.id, "apply");
        }



       function disableOtherButtons() {
          var username = "{{ username }}";
          var buttons = document.querySelectorAll("button");
          for (var i = 0; i < buttons.length; i++) {
            var cell = buttons[i].parentElement;
            if (cell.innerText.includes(username)) {
              // 자신이 신청한 칸은 취소 버튼이 활성화된 상태로 유지
              var button = cell.querySelector("button");
              button.disabled = false;
              button.style.display = "inline-block";
            } else if (cell.innerText !== "신청" && cell.innerText !== "") {
              // 다른 사용자가 신청한 칸은 버튼을 비활성화
              buttons[i].disabled = true;
              buttons[i].style.display = "none";
            } else {
              // 빈 칸의 신청 버튼은 활성화
              buttons[i].disabled = false;
              buttons[i].style.display = "inline-block";
            }
          }
        }





        function enableOtherButtons() {
            var buttons = document.querySelectorAll("button");
            for (var i = 0; i < buttons.length; i++) {
                buttons[i].disabled = false;
            }
        }
       function updateTableData(cellId, action) {
          var xhr = new XMLHttpRequest();
          xhr.open("POST", "/apply", true);
          xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");

          xhr.onreadystatechange = function() {
            if (xhr.readyState === 4 && xhr.status === 200) {
              updateTableUI();
            }
          };

          var data = "cell_id=" + cellId + "&username=" + "{{ username }}" + "&action=" + action;
          xhr.send(data);
        }



        function loadTableData() {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", "/get_table_data", true);

            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    var tableData = JSON.parse(xhr.responseText);
                    updateTableUI(tableData);
                }
            };

            xhr.send();
        }

        function updateTableUI() {
          var xhr = new XMLHttpRequest();
          xhr.open("GET", "/get_table_data", true);

          xhr.onreadystatechange = function() {
            if (xhr.readyState === 4 && xhr.status === 200) {
              var tableData = JSON.parse(xhr.responseText);
              var table = document.querySelector("table");
              for (var cellId in tableData) {
                var cell = table.querySelector("#" + cellId);
                var username = tableData[cellId];
                if (username) {
                  cell.innerHTML = username + ' <button onclick="apply(this.parentElement)">취소</button>';
                  if (username === "{{ username }}") {
                    disableOtherButtons();
                  } else {
                    var button = cell.querySelector("button");
                    button.style.display = "none";
                  }
                } else {
                  cell.innerHTML = '<button onclick="apply(this.parentElement)">신청</button>';
                }
              }
            }
          };

          xhr.send();
        }



    </script>
</head>
<body onload="loadTableData()">
    <section class ="container text-center">
        <h1>전시대 신청</h1>
        <table>
            <tbody>
                <tr>
                    <td id="cell_1_1">
                        <button class="apply-btn" onclick="apply(this.parentElement)">신청</button>
                    </td>
                    <td id="cell_1_2">
                        <button class="apply-btn" onclick="apply(this.parentElement)">신청</button>
                    </td>
                    <td id="cell_1_3">
                        <button class="apply-btn" onclick="apply(this.parentElement)">신청</button>
                    </td>
                    <td id="cell_1_4">
                        <button class="apply-btn" onclick="apply(this.parentElement)">신청</button>
                    </td>
                </tr>
                <tr>
                    <td id="cell_2_1">
                        <button class="apply-btn" onclick="apply(this.parentElement)">신청</button>
                    </td>
                    <td id="cell_2_2">
                        <button class="apply-btn" onclick="apply(this.parentElement)">신청</button>
                    </td>
                    <td id="cell_2_3">
                        <button class="apply-btn" onclick="apply(this.parentElement)">신청</button>
                    </td>
                    <td id="cell_2_4">
                        <button class="apply-btn" onclick="apply(this.parentElement)">신청</button>
                    </td>
                </tr>
                <tr>
                    <td id="cell_3_1">
                        <button class="apply-btn" onclick="apply(this.parentElement)">신청</button>
                    </td>
                    <td id="cell_3_2">
                        <button class="apply-btn" onclick="apply(this.parentElement)">신청</button>
                    </td>
                    <td id="cell_3_3">
                        <button class="apply-btn" onclick="apply(this.parentElement)">신청</button>
                    </td>
                    <td id="cell_3_4">
                        <button class="apply-btn" onclick="apply(this.parentElement)">신청</button>
                    </td>
                </tr>
            </tbody>
        </table>
    </section>
</body>


